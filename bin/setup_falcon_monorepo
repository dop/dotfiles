#!/bin/sh

# Initialize frontend monorepo with .env.local files with my preferred
# configuration.

looks_like_yoshi_project() {
    echo $(jq '(.wix.framework.type | type == "string" and test("^yoshi")) or has("yoshi") or (.scripts.start | type == "string" and contains("yoshi"))' $1)
}

update_env_local() {
    ENV_LOCAL=$1
    echo "Editing $ENV_LOCAL ..."
    if [ -f "$ENV_LOCAL" ]; then
        sed -i .bak -e '/^TRUSTED_CERTIFICATE/ d' -e '/^PROGRESS_BAR/ d' $ENV_LOCAL
    fi
    echo TRUSTED_CERTIFICATE=false >> $ENV_LOCAL
    echo PROGRESS_BAR=false >> $ENV_LOCAL
}

find . \( -type d -name node_modules -prune \) -o \( -type f -name package.json -print \) |
    while read PACKAGE_JSON; do
        ENV_LOCAL="$(dirname $PACKAGE_JSON)/.env.local"

        YOSHI=$(looks_like_yoshi_project "$PACKAGE_JSON")

        if [ $YOSHI = "true" ]; then
                update_env_local $ENV_LOCAL
        fi
    done

# add .envrc

echo ". falcon_env" > .envrc
